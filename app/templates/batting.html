{% extends "layout.html" %}

{% block title %}Batting{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='batting.css') }}">

<h1 class="title text-center my-4">Batting</h1>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="messages">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="info-section">
    <p>This page contains detailed batting statistics from Lahman's Baseball Dataset:</p>
    <div class="info-grid">
        <div class="info-item">
            <div class="column-name">Stint</div>
            <div class="description">Player's Stint</div>
        </div>
        <div class="info-item">
            <div class="column-name">G</div>
            <div class="description">Games</div>
        </div>
        <div class="info-item">
            <div class="column-name">AB</div>
            <div class="description">At Bats</div>
        </div>
        <div class="info-item">
            <div class="column-name">R</div>
            <div class="description">Runs</div>
        </div>
        <div class="info-item">
            <div class="column-name">H</div>
            <div class="description">Hits</div>
        </div>
        <div class="info-item">
            <div class="column-name">2B</div>
            <div class="description">Doubles</div>
        </div>
        <div class="info-item">
            <div class="column-name">3B</div>
            <div class="description">Triples</div>
        </div>
        <div class="info-item">
            <div class="column-name">HR</div>
            <div class="description">Home Runs</div>
        </div>
        <div class="info-item">
            <div class="column-name">RBI</div>
            <div class="description">Runs Batted In</div>
        </div>
        <div class="info-item">
            <div class="column-name">SB</div>
            <div class="description">Stolen Bases</div>
        </div>
        <div class="info-item">
            <div class="column-name">CS</div>
            <div class="description">Caught Stealing</div>
        </div>
        <div class="info-item">
            <div class="column-name">BB</div>
            <div class="description">Base on Balls</div>
        </div>
        <div class="info-item">
            <div class="column-name">SO</div>
            <div class="description">Strikeouts</div>
        </div>
        <div class="info-item">
            <div class="column-name">IBB</div>
            <div class="description">Intentional Walks</div>
        </div>
        <div class="info-item">
            <div class="column-name">HBP</div>
            <div class="description">Hit by Pitch</div>
        </div>
        <div class="info-item">
            <div class="column-name">SH</div>
            <div class="description">Sacrifice Hits</div>
        </div>
        <div class="info-item">
            <div class="column-name">SF</div>
            <div class="description">Sacrifice Flies</div>
        </div>
        <div class="info-item">
            <div class="column-name">GIDP</div>
            <div class="description">Grounded Into Double Plays</div>
        </div>
    </div>
</div>

<!-- Filter/Search Form -->
<form method="GET" action="{{ url_for('batting_page') }}" class="filter-form">
    <div class="form-group">
        <label for="year">Year:</label>
        <input type="number" name="year" id="year" value="{{ year_query }}" placeholder="Enter year" step="1">
    </div>

    <div class="form-group">
        <label for="team">Team:</label>
        <input type="text" name="team" id="team" value="{{ team_query }}" placeholder="Enter teamID">
    </div>

    <div class="form-group">
        <label for="league">League:</label>
        <select name="league" id="league" class="form-select" multiple>
            <optgroup label="Active Leagues" class="form-optgroup">
                {% for league in active_leagues %}
                <option value="{{ league.lgID }}" 
                        class="form-option" 
                        {% if league.lgID in league_query %}selected{% endif %}>
                    {{ league.league }} ({{ league.lgID }})
                </option>
                {% endfor %}
            </optgroup>
            <optgroup label="Inactive Leagues" class="form-optgroup">
                {% for league in inactive_leagues %}
                <option value="{{ league.lgID }}" 
                        class="form-option" 
                        {% if league.lgID in league_query %}selected{% endif %}>
                    {{ league.league }} ({{ league.lgID }})
                </option>
                {% endfor %}
            </optgroup>
        </select>
    </div>          

    <div class="form-group">
        <label for="sort_by">Sort By:</label>
        <select name="sort_by" id="sort_by">
            <option value="" class="form-option" {% if not sort_by %}selected{% endif %}>None</option>
            <option value="yearID" class="form-option" {% if sort_by == "yearID" %}selected{% endif %}>Year</option>
            <option value="teamID" class="form-option" {% if sort_by == "teamID" %}selected{% endif %}>Team</option>
            <option value="RBI" class="form-option" {% if sort_by == "RBI" %}selected{% endif %}>RBI</option>
            <option value="HR" class="form-option" {% if sort_by == "HR" %}selected{% endif %}>Home Runs</option>
        </select>
    </div>

    <div class="form-group">
        <label for="sort_order">Sort Order:</label>
        <select name="sort_order" id="sort_order">
            <option value="asc" class="form-option" {% if sort_order == "asc" %}selected{% endif %}>Ascending</option>
            <option value="desc" class="form-option" {% if sort_order == "desc" %}selected{% endif %}>Descending</option>
        </select>
    </div>

    <div class="form-buttons">
        <div class="left-buttons">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
        <div class="right-button">
            <button type="submit" class="btn btn-primary" name="action" value="view_all_data">View All</button>
        </div>
    </div>    
</form>

<!-- Records Table -->
<h2>Search Results</h2>

<div class="table-actions">
    <a href="{{ url_for('add_batting_record') }}" class="btn btn-success">Add New Record</a>
</div>

<div class="table-container">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Player Name</th>
                <th>Year</th>
                <th>Team</th>
                <th>League</th>
                <th>Stint</th>
                <th>Games</th>
                <th>AB</th>
                <th>R</th>
                <th>H</th>
                <th>2B</th>
                <th>3B</th>
                <th>HR</th>
                <th>RBI</th>
                <th>SB</th>
                <th>CS</th>
                <th>BB</th>
                <th>SO</th>
                <th>IBB</th>
                <th>HBP</th>
                <th>SH</th>
                <th>SF</th>
                <th>GIDP</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if batting_records %}
            {% for record in batting_records %}
            <tr>
                <td>{{ record.nameFirst }} {{ record.nameLast }}</td>
                <td>{{ record.yearID }}</td>
                <td>{{ record.teamID }}</td>
                <td>{{ record.lgID }}</td>
                <td>{{ record.stint }}</td>
                <td>{{ record.G }}</td>
                <td>{{ record.AB }}</td>
                <td>{{ record.R }}</td>
                <td>{{ record.H }}</td>
                <td>{{ record['2B'] }}</td>
                <td>{{ record['3B'] }}</td>
                <td>{{ record.HR }}</td>
                <td>{{ record.RBI }}</td>
                <td>{{ record.SB }}</td>
                <td>{{ record.CS }}</td>
                <td>{{ record.BB }}</td>
                <td>{{ record.SO }}</td>
                <td>{{ record.IBB }}</td>
                <td>{{ record.HBP }}</td>
                <td>{{ record.SH }}</td>
                <td>{{ record.SF }}</td>
                <td>{{ record.GIDP }}</td>
                <td>
                    <form method="GET" action="{{ url_for('update_batting_record', record_id=record.ID) }}" style="display:inline;">
                        <button type="submit" class="btn btn-secondary">Update</button>
                    </form>
                    <form method="POST" action="{{ url_for('delete_batting_record', record_id=record.ID) }}" style="display:inline;">
                        <button type="button" class="btn btn-danger" onclick="openDeleteModal(this.closest('form'))">Delete</button>
                    </form>                    
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="23">No records found.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="close" aria-label="Close" onclick="closeDeleteModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    let deleteForm;

    function openDeleteModal(form) {
        deleteForm = form;
        const modal = document.getElementById("deleteModal");
        modal.style.display = "flex";
    }

    function closeDeleteModal() {
        const modal = document.getElementById("deleteModal");
        modal.style.display = "none";
    }

    document.getElementById("confirmDeleteButton").addEventListener("click", function () {
        if (deleteForm) {
            deleteForm.submit();
        }
        closeDeleteModal();
    });
</script>

{% endblock %}
